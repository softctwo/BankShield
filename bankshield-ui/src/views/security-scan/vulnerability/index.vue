<template>
  <div class="vulnerability-container">
    <el-card shadow="never">
      <el-form :inline="true" :model="queryForm">
        <el-form-item label="漏洞名称">
          <el-input v-model="queryForm.vulnName" placeholder="请输入漏洞名称" clearable />
        </el-form-item>
        <el-form-item label="严重程度">
          <el-select v-model="queryForm.severity" placeholder="请选择" clearable>
            <el-option label="严重" value="CRITICAL" />
            <el-option label="高危" value="HIGH" />
            <el-option label="中危" value="MEDIUM" />
            <el-option label="低危" value="LOW" />
          </el-select>
        </el-form-item>
        <el-form-item label="漏洞类型">
          <el-select v-model="queryForm.vulnType" placeholder="请选择" clearable>
            <el-option label="SQL注入" value="SQL_INJECTION" />
            <el-option label="XSS" value="XSS" />
            <el-option label="依赖漏洞" value="DEPENDENCY" />
            <el-option label="安全配置" value="SECURITY_MISCONFIGURATION" />
          </el-select>
        </el-form-item>
        <el-form-item label="状态">
          <el-select v-model="queryForm.status" placeholder="请选择" clearable>
            <el-option label="未解决" value="OPEN" />
            <el-option label="处理中" value="IN_PROGRESS" />
            <el-option label="已解决" value="RESOLVED" />
            <el-option label="误报" value="FALSE_POSITIVE" />
          </el-select>
        </el-form-item>
        <el-form-item>
          <el-button type="primary" @click="handleQuery">
            <el-icon><Search /></el-icon> 查询
          </el-button>
          <el-button @click="handleReset">
            <el-icon><Refresh /></el-icon> 重置
          </el-button>
        </el-form-item>
      </el-form>

      <el-table v-loading="loading" :data="vulnList" border>
        <el-table-column prop="vulnCode" label="漏洞编码" width="120" />
        <el-table-column prop="vulnName" label="漏洞名称" min-width="200" show-overflow-tooltip />
        <el-table-column prop="vulnType" label="类型" width="120">
          <template #default="{ row }">
            <el-tag>{{ getVulnTypeLabel(row.vulnType) }}</el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="severity" label="严重程度" width="100">
          <template #default="{ row }">
            <el-tag :type="getSeverityType(row.severity)">{{ row.severity }}</el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="cvssScore" label="CVSS评分" width="100" />
        <el-table-column prop="location" label="位置" min-width="200" show-overflow-tooltip />
        <el-table-column prop="status" label="状态" width="100">
          <template #default="{ row }">
            <el-tag :type="getStatusType(row.status)">{{ getStatusLabel(row.status) }}</el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="assignedTo" label="处理人" width="120" />
        <el-table-column prop="createdTime" label="发现时间" width="180" />
        <el-table-column label="操作" width="250" fixed="right">
          <template #default="{ row }">
            <el-button link type="primary" size="small" @click="handleView(row)">详情</el-button>
            <el-button v-if="row.status === 'OPEN'" link type="success" size="small" @click="handleAssign(row)">分配</el-button>
            <el-button v-if="row.status === 'IN_PROGRESS'" link type="success" size="small" @click="handleResolve(row)">解决</el-button>
            <el-button link type="warning" size="small" @click="handleFalsePositive(row)">误报</el-button>
          </template>
        </el-table-column>
      </el-table>

      <el-pagination
        v-model:current-page="queryForm.current"
        v-model:page-size="queryForm.size"
        :total="total"
        :page-sizes="[10, 20, 50, 100]"
        layout="total, sizes, prev, pager, next, jumper"
        @size-change="handleQuery"
        @current-change="handleQuery"
      />
    </el-card>

    <el-dialog v-model="detailVisible" title="漏洞详情" width="800px">
      <el-descriptions :column="2" border>
        <el-descriptions-item label="漏洞编码">{{ currentVuln.vulnCode }}</el-descriptions-item>
        <el-descriptions-item label="漏洞名称">{{ currentVuln.vulnName }}</el-descriptions-item>
        <el-descriptions-item label="漏洞类型">{{ getVulnTypeLabel(currentVuln.vulnType) }}</el-descriptions-item>
        <el-descriptions-item label="严重程度">
          <el-tag :type="getSeverityType(currentVuln.severity)">{{ currentVuln.severity }}</el-tag>
        </el-descriptions-item>
        <el-descriptions-item label="CVSS评分">{{ currentVuln.cvssScore }}</el-descriptions-item>
        <el-descriptions-item label="CVE编号">{{ currentVuln.cveId || '-' }}</el-descriptions-item>
        <el-descriptions-item label="CWE编号">{{ currentVuln.cweId || '-' }}</el-descriptions-item>
        <el-descriptions-item label="状态">
          <el-tag :type="getStatusType(currentVuln.status)">{{ getStatusLabel(currentVuln.status) }}</el-tag>
        </el-descriptions-item>
        <el-descriptions-item label="位置" :span="2">{{ currentVuln.location }}</el-descriptions-item>
        <el-descriptions-item label="描述" :span="2">{{ currentVuln.description }}</el-descriptions-item>
        <el-descriptions-item label="影响" :span="2">{{ currentVuln.impact }}</el-descriptions-item>
        <el-descriptions-item label="修复建议" :span="2">
          <pre style="white-space: pre-wrap">{{ currentVuln.recommendation }}</pre>
        </el-descriptions-item>
        <el-descriptions-item label="漏洞证明" :span="2">{{ currentVuln.proofOfConcept }}</el-descriptions-item>
      </el-descriptions>
    </el-dialog>

    <el-dialog v-model="assignVisible" title="分配漏洞" width="400px">
      <el-form :model="assignForm" label-width="80px">
        <el-form-item label="处理人">
          <el-input v-model="assignForm.assignedTo" placeholder="请输入处理人邮箱" />
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="assignVisible = false">取消</el-button>
        <el-button type="primary" @click="submitAssign">确定</el-button>
      </template>
    </el-dialog>

    <el-dialog v-model="resolveVisible" title="解决漏洞" width="500px">
      <el-form :model="resolveForm" label-width="100px">
        <el-form-item label="解决说明">
          <el-input v-model="resolveForm.resolutionNotes" type="textarea" :rows="4" placeholder="请输入解决说明" />
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="resolveVisible = false">取消</el-button>
        <el-button type="primary" @click="submitResolve">确定</el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { Search, Refresh } from '@element-plus/icons-vue'
import request from '@/utils/request'

const loading = ref(false)
const vulnList = ref<any[]>([])
const total = ref(0)

const queryForm = reactive({
  current: 1,
  size: 10,
  vulnName: '',
  severity: '',
  vulnType: '',
  status: ''
})

const detailVisible = ref(false)
const currentVuln = ref<any>({})

const assignVisible = ref(false)
const assignForm = reactive({
  id: 0,
  assignedTo: ''
})

const resolveVisible = ref(false)
const resolveForm = reactive({
  id: 0,
  resolutionNotes: ''
})

const loadVulnList = async () => {
  loading.value = true
  try {
    const res = await request.get('/api/security-scan/vulnerabilities', { params: queryForm })
    vulnList.value = res.data?.records || []
    total.value = res.data?.total || 0
  } catch (error) {
    ElMessage.error('加载漏洞列表失败')
  } finally {
    loading.value = false
  }
}

const handleQuery = () => {
  queryForm.current = 1
  loadVulnList()
}

const handleReset = () => {
  queryForm.vulnName = ''
  queryForm.severity = ''
  queryForm.vulnType = ''
  queryForm.status = ''
  handleQuery()
}

const handleView = async (row: any) => {
  try {
    const res = await request.get(`/api/security-scan/vulnerabilities/${row.id}`)
    currentVuln.value = res.data || {}
    detailVisible.value = true
  } catch (error) {
    ElMessage.error('加载漏洞详情失败')
  }
}

const handleAssign = (row: any) => {
  assignForm.id = row.id
  assignForm.assignedTo = ''
  assignVisible.value = true
}

const submitAssign = async () => {
  if (!assignForm.assignedTo) {
    ElMessage.warning('请输入处理人')
    return
  }
  try {
    await request.put(`/api/security-scan/vulnerabilities/${assignForm.id}/assign`, {
      assignedTo: assignForm.assignedTo
    })
    ElMessage.success('分配成功')
    assignVisible.value = false
    loadVulnList()
  } catch (error) {
    ElMessage.error('分配失败')
  }
}

const handleResolve = (row: any) => {
  resolveForm.id = row.id
  resolveForm.resolutionNotes = ''
  resolveVisible.value = true
}

const submitResolve = async () => {
  if (!resolveForm.resolutionNotes) {
    ElMessage.warning('请输入解决说明')
    return
  }
  try {
    await request.post(`/api/security-scan/vulnerabilities/${resolveForm.id}/resolve`, {
      resolutionNotes: resolveForm.resolutionNotes
    })
    ElMessage.success('标记为已解决')
    resolveVisible.value = false
    loadVulnList()
  } catch (error) {
    ElMessage.error('操作失败')
  }
}

const handleFalsePositive = async (row: any) => {
  try {
    await ElMessageBox.prompt('请输入误报原因', '标记为误报', {
      confirmButtonText: '确定',
      cancelButtonText: '取消'
    })
    await request.post(`/api/security-scan/vulnerabilities/${row.id}/false-positive`, {
      reason: '误报'
    })
    ElMessage.success('已标记为误报')
    loadVulnList()
  } catch (error: any) {
    if (error !== 'cancel') {
      ElMessage.error('操作失败')
    }
  }
}

const getVulnTypeLabel = (type: string) => {
  const map: Record<string, string> = {
    SQL_INJECTION: 'SQL注入',
    XSS: 'XSS',
    DEPENDENCY: '依赖漏洞',
    SECURITY_MISCONFIGURATION: '安全配置'
  }
  return map[type] || type
}

const getSeverityType = (severity: string) => {
  const map: Record<string, any> = {
    CRITICAL: 'danger',
    HIGH: 'danger',
    MEDIUM: 'warning',
    LOW: 'success'
  }
  return map[severity] || 'info'
}

const getStatusLabel = (status: string) => {
  const map: Record<string, string> = {
    OPEN: '未解决',
    IN_PROGRESS: '处理中',
    RESOLVED: '已解决',
    FALSE_POSITIVE: '误报'
  }
  return map[status] || status
}

const getStatusType = (status: string) => {
  const map: Record<string, any> = {
    OPEN: 'danger',
    IN_PROGRESS: 'warning',
    RESOLVED: 'success',
    FALSE_POSITIVE: 'info'
  }
  return map[status] || 'info'
}

onMounted(() => {
  loadVulnList()
})
</script>

<style scoped lang="less">
.vulnerability-container {
  padding: 20px;
}
</style>
