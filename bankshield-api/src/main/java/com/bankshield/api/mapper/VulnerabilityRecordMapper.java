package com.bankshield.api.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.bankshield.api.entity.VulnerabilityRecord;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;
import org.apache.ibatis.annotations.Select;

import java.util.List;
import java.util.Map;

@Mapper
public interface VulnerabilityRecordMapper extends BaseMapper<VulnerabilityRecord> {

    @Select("SELECT * FROM vulnerability_record WHERE task_id = #{taskId} ORDER BY severity, created_time DESC")
    List<VulnerabilityRecord> selectByTaskId(@Param("taskId") Long taskId);

    @Select("SELECT * FROM vulnerability_record WHERE severity = #{severity} ORDER BY created_time DESC")
    List<VulnerabilityRecord> selectBySeverity(@Param("severity") String severity);

    @Select("SELECT * FROM vulnerability_record WHERE status = #{status} ORDER BY created_time DESC")
    List<VulnerabilityRecord> selectByStatus(@Param("status") String status);

    @Select("SELECT severity, COUNT(*) as count FROM vulnerability_record GROUP BY severity")
    List<Map<String, Object>> countBySeverity();

    @Select("SELECT vuln_type, COUNT(*) as count FROM vulnerability_record GROUP BY vuln_type ORDER BY count DESC LIMIT 10")
    List<Map<String, Object>> countByType();

    @Select("SELECT COUNT(*) FROM vulnerability_record WHERE task_id = #{taskId} AND severity IN ('CRITICAL', 'HIGH')")
    int countHighRiskByTask(@Param("taskId") Long taskId);
}
