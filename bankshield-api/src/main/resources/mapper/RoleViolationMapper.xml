<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bankshield.api.mapper.RoleViolationMapper">

    <!-- 查询未处理的违规记录 -->
    <select id="selectUnhandledViolations" resultType="com.bankshield.api.entity.RoleViolation">
        SELECT *
        FROM role_violation
        WHERE status = 0
        ORDER BY violation_time DESC
    </select>

    <!-- 查询未发送告警的违规记录 -->
    <select id="selectUnsentAlerts" resultType="com.bankshield.api.entity.RoleViolation">
        SELECT *
        FROM role_violation
        WHERE alert_sent = 0
        AND status = 0
        ORDER BY violation_time DESC
    </select>

    <!-- 查询指定用户的违规记录 -->
    <select id="selectByUserId" resultType="com.bankshield.api.entity.RoleViolation">
        SELECT *
        FROM role_violation
        WHERE user_id = #{userId}
        <if test="status != null">
            AND status = #{status}
        </if>
        ORDER BY violation_time DESC
    </select>

    <!-- 查询指定时间范围内的违规记录 -->
    <select id="selectByTimeRange" resultType="com.bankshield.api.entity.RoleViolation">
        SELECT *
        FROM role_violation
        WHERE violation_time BETWEEN #{startTime} AND #{endTime}
        <if test="status != null">
            AND status = #{status}
        </if>
        ORDER BY violation_time DESC
    </select>

    <!-- 统计违规记录数量 -->
    <select id="countViolations" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM role_violation
        <if test="status != null">
            WHERE status = #{status}
        </if>
    </select>

    <!-- 更新告警发送状态 -->
    <update id="updateAlertStatus">
        UPDATE role_violation
        SET alert_sent = #{alertSent}
        WHERE id = #{id}
    </update>

</mapper>