# 系统架构设计

## 1. 总体架构

BankShield采用微服务架构设计，基于Spring Cloud生态系统构建，系统架构图如下：

```
┌─────────────────────────────────────────────────────────────────────┐
│                        负载均衡层 (Nginx)                            │
└─────────────────────────────────────────────────────────────────────┘
                                   │
        ┌──────────────────────────┼──────────────────────────┐
        │                          │                          │
┌───────▼──────┐         ┌────────▼────────┐        ┌──────▼──────┐
│   Web端      │         │   移动端        │        │  第三方API   │
│  (Vue3)      │         │  (App/小程序)    │        │  (商户/银行)  │
└───────┬──────┘         └────────┬────────┘        └──────┬──────┘
        │                         │                        │
┌───────▼─────────────────────────▼────────────────────────▼───────┐
│                      API网关层 (Gateway)                         │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │  功能: 路由、限流、熔断、身份认证、日志记录                   │ │
│  └─────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────┘
                                   │
┌──────────────────────────────────────────────────────────────────┐
│                     服务注册与配置中心 (Eureka)                  │
└──────────────────────────────────────────────────────────────────┘
                                   │
        ┌──────────────────────────┼──────────────────────────┐
        │                          │                          │
┌───────▼────────┐      ┌──────────▼──────────┐      ┌──────▼───────┐
│  认证服务       │      │  核心业务服务       │      │  监控服务     │
│  (Auth)        │      │  (API)              │      │  (Monitor)   │
└────────────────┘      └─────────────────────┘      └──────────────┘
        │                          │                          │
        └──────────────────┬───────┴─────────────────┬──────────┘
                           │                         │
┌──────────────────────────▼─────────────────────────▼────────────────┐
│                    数据存储层                                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────────────┐    │
│  │  MySQL   │  │  Redis   │  │  MongoDB │  │   Elasticsearch │    │
│  │  (业务)  │  │  (缓存)  │  │  (日志)  │  │   (搜索/分析)   │    │
│  └──────────┘  └──────────┘  └──────────┘  └─────────────────┘    │
└──────────────────────────────────────────────────────────────────────┘
```

## 2. 技术栈

### 后端技术
- **框架**: Spring Boot 2.7 + Spring Cloud 2021
- **微服务**: Spring Cloud Netflix Eureka、Gateway、OpenFeign
- **安全**: Spring Security + JWT + 国密算法
- **数据库**: MySQL 8.0 + MyBatis-Plus
- **缓存**: Redis 6.0
- **监控**: Spring Boot Admin + Prometheus + Grafana
- **部署**: Docker + Docker Compose

### 前端技术
- **框架**: Vue 3.4 + TypeScript
- **UI库**: Element Plus 2.4
- **状态管理**: Pinia 2.1
- **路由**: Vue Router 4.2
- **构建工具**: Vite 5.0
- **图表**: ECharts 5.4

### 安全与加密
- **国密算法**: SM2（非对称加密）、SM3（哈希）、SM4（对称加密）
- **国际标准**: AES-256、RSA-2048、SHA-256
- **认证**: JWT Token + Refresh Token机制

## 3. 核心模块设计

### 3.1 认证授权服务 (Auth Service)
```
┌─────────────────────────────────────────┐
│         认证授权服务 (Auth)             │
├─────────────────────────────────────────┤
│  1. 用户登录认证                         │
│  2. JWT Token生成与验证                  │
│  3. 权限管理 (RBAC)                     │
│  4. 会话管理                             │
│  5. 审计日志记录                         │
└─────────────────────────────────────────┘
```

**接口说明**:
- POST /auth/login - 用户登录
- POST /auth/logout - 用户登出
- POST /auth/refresh - Token刷新
- GET /auth/user/info - 获取用户信息

### 3.2 核心业务服务 (API Service)
```
┌─────────────────────────────────────────┐
│        核心业务服务 (API)               │
├─────────────────────────────────────────┤
│  1. 数据加密管理                         │
│  2. 访问控制管理                         │
│  3. 审计追踪管理                         │
│  4. 敏感数据识别                         │
│  5. 数据脱敏管理                         │
│  6. 安全态势可视化                       │
└─────────────────────────────────────────┘
```

### 3.3 加密服务 (Encrypt Service)
```
┌─────────────────────────────────────────┐
│          加密服务 (Encrypt)             │
├─────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐    │
│  │  国密算法     │  │  国际标准     │    │
│  │  SM2/SM3/SM4 │  │  AES/RSA/SHA │    │
│  └──────────────┘  └──────────────┘    │
│  支持:                                   │
│  • 密钥管理                              │
│  • 数据加密解密                          │
│  • 数字签名验签                          │
│  • 哈希计算                              │
└─────────────────────────────────────────┘
```

## 4. 数据库设计

### 4.1 核心数据表

**用户表 (sys_user)**
```sql
CREATE TABLE sys_user (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  username VARCHAR(50) NOT NULL UNIQUE COMMENT '用户名',
  password VARCHAR(255) NOT NULL COMMENT '密码',
  name VARCHAR(100) COMMENT '姓名',
  phone VARCHAR(20) COMMENT '手机号',
  email VARCHAR(100) COMMENT '邮箱',
  dept_id BIGINT COMMENT '部门ID',
  status TINYINT DEFAULT 1 COMMENT '状态: 0-禁用, 1-启用',
  create_time DATETIME COMMENT '创建时间',
  update_time DATETIME COMMENT '更新时间',
  create_by VARCHAR(50) COMMENT '创建人',
  update_by VARCHAR(50) COMMENT '更新人',
  INDEX idx_username(username),
  INDEX idx_dept_id(dept_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

**角色表 (sys_role)**
```sql
CREATE TABLE sys_role (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  role_name VARCHAR(50) NOT NULL COMMENT '角色名称',
  role_code VARCHAR(50) NOT NULL UNIQUE COMMENT '角色编码',
  description VARCHAR(255) COMMENT '描述',
  status TINYINT DEFAULT 1 COMMENT '状态',
  create_time DATETIME,
  update_time DATETIME
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='角色表';
```

**敏感数据类型表 (sensitive_data_type)**
```sql
CREATE TABLE sensitive_data_type (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  type_name VARCHAR(100) NOT NULL COMMENT '类型名称',
  type_code VARCHAR(50) NOT NULL UNIQUE COMMENT '类型编码',
  pattern VARCHAR(255) COMMENT '正则表达式',
  encryption_alg VARCHAR(50) COMMENT '加密算法',
  mask_rule VARCHAR(255) COMMENT '脱敏规则',
  description VARCHAR(255) COMMENT '描述',
  create_time DATETIME,
  update_time DATETIME
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='敏感数据类型表';
```

## 5. 安全架构

### 5.1 多层次安全防护
```
┌─────────────────────────────────────────┐
│      应用层安全 (WAF + RateLimit)      │
├─────────────────────────────────────────┤
│      认证授权层 (JWT + RBAC)           │
├─────────────────────────────────────────┤
│      服务层安全 (TLS + 服务认证)        │
├─────────────────────────────────────────┤
│      数据层安全 (加密 + 脱敏)           │
├─────────────────────────────────────────┤
│      存储安全 (数据库审计 + 备份)       │
└─────────────────────────────────────────┘
```

### 5.2 数据加密策略

**传输加密**:
- 使用TLS 1.3协议加密传输通道
- 采用国密算法套件

**存储加密**:
- 敏感字段使用SM4加密
- 关键业务数据使用SM2签名
- 密钥由专门KMS系统管理

**使用加密**:
- 内存中使用加密保护
- 核心密钥存储在HSM中

## 6. 监控与审计

### 6.1 监控指标
- **应用监控**: JVM、内存、线程、GC
- **业务监控**: 接口调用量、响应时间、错误率
- **安全监控**: 登录失败、异常访问、数据访问审计
- **基础设施**: CPU、内存、磁盘、网络

### 6.2 日志体系
- **应用日志**: 业务操作日志
- **安全日志**: 登录、权限变更等
- **审计日志**: 数据访问、修改记录
- **系统日志**: 系统运行状态

### 6.3 告警机制
- 实时告警：钉钉、短信、邮件
- 告警分级：INFO、WARNING、CRITICAL
- 告警收敛：避免告警风暴

## 7. 部署架构

### 7.1 容器化部署
```
┌─────────────────────────────────────────┐
│         Docker容器化部署                │
├─────────────────────────────────────────┤
│  ┌──────────┐  ┌──────────┐  ┌────────┐ │
│  │  Gateway │  │  API     │  │  Auth  │ │
│  │  容器    │  │  容器    │  │  容器  │ │
│  └────┬─────┘  └────┬─────┘  └───┬────┘ │
│       │             │              │      │
│  ┌────▼─────────────▼──────────────▼─────┐│
│  │        MySQL主从集群                 ││
│  │      (一主两从+高可用)               ││
│  └──────────────────────────────────────┘│
└──────────────────────────────────────────┘
```

### 7.2 高可用设计
- **多实例部署**: 每个服务至少2个实例
- **数据库主从**: MySQL主从复制 + MHA高可用
- **Redis集群**: 哨兵模式或Cluster模式
- **灾备**: 异地数据备份与恢复机制

## 8. 扩展性设计

### 8.1 水平扩展
- 所有服务无状态设计
- 支持根据负载动态扩容
- 使用Kubernetes进行编排管理

### 8.2 插件化架构
- 支持自定义加密算法插件
- 支持自定义脱敏规则插件
- 支持自定义数据源插件