# BankShield 部署手册

**文档版本**: v1.0  
**项目名称**: BankShield - 银行数据安全管理系统  
**编写日期**: 2026-01-07  

---

## 1. 部署架构

### 1.1 部署环境

| 环境 | 说明 | 访问地址 |
|------|------|---------|
| 开发环境 | 本地开发测试 | http://localhost:3000 |
| 测试环境 | 功能测试验证 | http://test.bankshield.com |
| 预发布环境 | 生产前验证 | http://pre.bankshield.com |
| 生产环境 | 正式运行环境 | https://bankshield.com |

### 1.2 服务器配置

**最低配置**:
- CPU: 4核
- 内存: 8GB
- 硬盘: 100GB SSD
- 网络: 10Mbps

**推荐配置**:
- CPU: 8核+
- 内存: 16GB+
- 硬盘: 500GB SSD
- 网络: 100Mbps+

---

## 2. 环境准备

### 2.1 基础软件安装

#### 2.1.1 安装JDK 17

```bash
# CentOS/RHEL
sudo yum install java-17-openjdk-devel

# Ubuntu/Debian
sudo apt-get install openjdk-17-jdk

# 验证安装
java -version
```

#### 2.1.2 安装MySQL 8.0

```bash
# CentOS/RHEL
sudo yum install mysql-server

# Ubuntu/Debian
sudo apt-get install mysql-server

# 启动MySQL
sudo systemctl start mysqld
sudo systemctl enable mysqld

# 初始化数据库
mysql_secure_installation
```

#### 2.1.3 安装Redis

```bash
# CentOS/RHEL
sudo yum install redis

# Ubuntu/Debian
sudo apt-get install redis-server

# 启动Redis
sudo systemctl start redis
sudo systemctl enable redis
```

#### 2.1.4 安装Nginx

```bash
# CentOS/RHEL
sudo yum install nginx

# Ubuntu/Debian
sudo apt-get install nginx

# 启动Nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

### 2.2 数据库初始化

```bash
# 登录MySQL
mysql -u root -p

# 创建数据库
CREATE DATABASE bankshield CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 创建用户
CREATE USER 'bankshield'@'%' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON bankshield.* TO 'bankshield'@'%';
FLUSH PRIVILEGES;

# 导入初始化脚本
USE bankshield;
SOURCE /path/to/sql/init_database.sql;
SOURCE /path/to/sql/init_data.sql;
```

---

## 3. 应用部署

### 3.1 后端部署

#### 3.1.1 构建应用

```bash
# 克隆代码
git clone https://github.com/your-org/BankShield.git
cd BankShield

# 构建项目
mvn clean package -DskipTests -Pprod

# 构建产物位置
# bankshield-api/target/bankshield-api-1.0.0.jar
```

#### 3.1.2 配置文件

创建 `/opt/bankshield/config/application-prod.yml`:

```yaml
server:
  port: 8081

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/bankshield?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai
    username: bankshield
    password: ${DB_PASSWORD}
    
  redis:
    host: localhost
    port: 6379
    password: ${REDIS_PASSWORD}
    
logging:
  level:
    root: INFO
    com.bankshield: INFO
  file:
    name: /var/log/bankshield/application.log
```

#### 3.1.3 启动脚本

创建 `/opt/bankshield/start.sh`:

```bash
#!/bin/bash

APP_NAME=bankshield-api
JAR_FILE=/opt/bankshield/bankshield-api-1.0.0.jar
PID_FILE=/var/run/bankshield.pid
LOG_FILE=/var/log/bankshield/application.log

# 检查是否已运行
if [ -f "$PID_FILE" ]; then
    PID=$(cat $PID_FILE)
    if ps -p $PID > /dev/null; then
        echo "$APP_NAME is already running (PID: $PID)"
        exit 1
    fi
fi

# 启动应用
nohup java -jar $JAR_FILE \
    --spring.profiles.active=prod \
    --spring.config.location=/opt/bankshield/config/ \
    > $LOG_FILE 2>&1 &

# 保存PID
echo $! > $PID_FILE
echo "$APP_NAME started (PID: $!)"
```

#### 3.1.4 停止脚本

创建 `/opt/bankshield/stop.sh`:

```bash
#!/bin/bash

APP_NAME=bankshield-api
PID_FILE=/var/run/bankshield.pid

if [ ! -f "$PID_FILE" ]; then
    echo "$APP_NAME is not running"
    exit 1
fi

PID=$(cat $PID_FILE)
if ps -p $PID > /dev/null; then
    kill $PID
    echo "$APP_NAME stopped (PID: $PID)"
    rm -f $PID_FILE
else
    echo "$APP_NAME is not running"
    rm -f $PID_FILE
fi
```

#### 3.1.5 设置为系统服务

创建 `/etc/systemd/system/bankshield.service`:

```ini
[Unit]
Description=BankShield API Service
After=network.target mysql.service redis.service

[Service]
Type=forking
User=bankshield
Group=bankshield
WorkingDirectory=/opt/bankshield
ExecStart=/opt/bankshield/start.sh
ExecStop=/opt/bankshield/stop.sh
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启动服务:

```bash
# 重载systemd配置
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start bankshield

# 设置开机自启
sudo systemctl enable bankshield

# 查看状态
sudo systemctl status bankshield
```

### 3.2 前端部署

#### 3.2.1 构建前端

```bash
cd bankshield-ui

# 安装依赖
npm install

# 生产构建
npm run build

# 构建产物在 dist/ 目录
```

#### 3.2.2 Nginx配置

创建 `/etc/nginx/conf.d/bankshield.conf`:

```nginx
server {
    listen 80;
    server_name bankshield.com;
    
    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name bankshield.com;
    
    # SSL证书配置
    ssl_certificate /etc/nginx/ssl/bankshield.crt;
    ssl_certificate_key /etc/nginx/ssl/bankshield.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    
    # 前端静态文件
    root /var/www/bankshield;
    index index.html;
    
    # SPA路由支持
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # API代理
    location /api/ {
        proxy_pass http://localhost:8081/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Gzip压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    gzip_min_length 1000;
}
```

部署前端文件:

```bash
# 复制构建产物
sudo cp -r dist/* /var/www/bankshield/

# 设置权限
sudo chown -R nginx:nginx /var/www/bankshield

# 重载Nginx
sudo nginx -t
sudo systemctl reload nginx
```

---

## 4. Docker部署

### 4.1 Dockerfile

**后端Dockerfile** (`bankshield-api/Dockerfile`):

```dockerfile
FROM openjdk:17-jdk-slim

WORKDIR /app

COPY target/bankshield-api-1.0.0.jar app.jar

EXPOSE 8081

ENTRYPOINT ["java", "-jar", "app.jar", "--spring.profiles.active=prod"]
```

**前端Dockerfile** (`bankshield-ui/Dockerfile`):

```dockerfile
FROM node:18-alpine AS builder

WORKDIR /app

COPY package*.json ./
RUN npm install

COPY . .
RUN npm run build

FROM nginx:alpine

COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

### 4.2 Docker Compose

创建 `docker-compose.yml`:

```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: bankshield-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: bankshield
      MYSQL_USER: bankshield
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - mysql-data:/var/lib/mysql
      - ./sql:/docker-entrypoint-initdb.d
    ports:
      - "3306:3306"
    networks:
      - bankshield-network

  redis:
    image: redis:6-alpine
    container_name: bankshield-redis
    command: redis-server --requirepass ${REDIS_PASSWORD}
    ports:
      - "6379:6379"
    networks:
      - bankshield-network

  api:
    build:
      context: ./bankshield-api
      dockerfile: Dockerfile
    container_name: bankshield-api
    environment:
      SPRING_PROFILES_ACTIVE: prod
      DB_HOST: mysql
      DB_PASSWORD: ${MYSQL_PASSWORD}
      REDIS_HOST: redis
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    ports:
      - "8081:8081"
    depends_on:
      - mysql
      - redis
    networks:
      - bankshield-network

  ui:
    build:
      context: ./bankshield-ui
      dockerfile: Dockerfile
    container_name: bankshield-ui
    ports:
      - "80:80"
    depends_on:
      - api
    networks:
      - bankshield-network

volumes:
  mysql-data:

networks:
  bankshield-network:
    driver: bridge
```

启动服务:

```bash
# 创建.env文件
cat > .env << EOF
MYSQL_ROOT_PASSWORD=your_root_password
MYSQL_PASSWORD=your_password
REDIS_PASSWORD=your_redis_password
EOF

# 启动所有服务
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

---

## 5. Kubernetes部署

### 5.1 创建命名空间

```bash
kubectl create namespace bankshield-prod
```

### 5.2 部署配置

**MySQL部署** (`k8s/mysql-deployment.yaml`):

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc
  namespace: bankshield-prod
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql
  namespace: bankshield-prod
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
      - name: mysql
        image: mysql:8.0
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: root-password
        - name: MYSQL_DATABASE
          value: bankshield
        ports:
        - containerPort: 3306
        volumeMounts:
        - name: mysql-storage
          mountPath: /var/lib/mysql
      volumes:
      - name: mysql-storage
        persistentVolumeClaim:
          claimName: mysql-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: mysql
  namespace: bankshield-prod
spec:
  selector:
    app: mysql
  ports:
  - port: 3306
    targetPort: 3306
```

**API部署** (`k8s/api-deployment.yaml`):

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: bankshield-api
  namespace: bankshield-prod
spec:
  replicas: 3
  selector:
    matchLabels:
      app: bankshield-api
  template:
    metadata:
      labels:
        app: bankshield-api
    spec:
      containers:
      - name: api
        image: bankshield/api:latest
        ports:
        - containerPort: 8081
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: prod
        - name: DB_HOST
          value: mysql
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "2000m"
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8081
          initialDelaySeconds: 60
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /actuator/health
            port: 8081
          initialDelaySeconds: 30
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: bankshield-api
  namespace: bankshield-prod
spec:
  selector:
    app: bankshield-api
  ports:
  - port: 8081
    targetPort: 8081
  type: ClusterIP
```

部署应用:

```bash
# 创建Secret
kubectl create secret generic mysql-secret \
  --from-literal=root-password=your_password \
  -n bankshield-prod

# 部署MySQL
kubectl apply -f k8s/mysql-deployment.yaml

# 部署API
kubectl apply -f k8s/api-deployment.yaml

# 查看部署状态
kubectl get pods -n bankshield-prod
kubectl get svc -n bankshield-prod
```

---

## 6. 监控与日志

### 6.1 应用监控

```bash
# 查看应用日志
tail -f /var/log/bankshield/application.log

# 查看系统资源
top
htop

# 查看端口占用
netstat -tulpn | grep 8081
```

### 6.2 健康检查

```bash
# 检查应用健康状态
curl http://localhost:8081/actuator/health

# 检查数据库连接
mysql -u bankshield -p -e "SELECT 1"

# 检查Redis连接
redis-cli -a password ping
```

---

## 7. 备份与恢复

### 7.1 数据库备份

```bash
# 全量备份
mysqldump -u root -p bankshield > backup_$(date +%Y%m%d).sql

# 定时备份脚本
cat > /opt/bankshield/backup.sh << 'EOF'
#!/bin/bash
BACKUP_DIR=/backup/mysql
DATE=$(date +%Y%m%d_%H%M%S)
mysqldump -u root -p${MYSQL_PASSWORD} bankshield | gzip > ${BACKUP_DIR}/bankshield_${DATE}.sql.gz
# 删除30天前的备份
find ${BACKUP_DIR} -name "*.sql.gz" -mtime +30 -delete
EOF

# 添加到crontab
crontab -e
# 每天凌晨2点执行备份
0 2 * * * /opt/bankshield/backup.sh
```

### 7.2 数据恢复

```bash
# 恢复数据库
mysql -u root -p bankshield < backup_20260107.sql

# 从压缩文件恢复
gunzip < bankshield_20260107_020000.sql.gz | mysql -u root -p bankshield
```

---

## 8. 故障排查

### 8.1 常见问题

**应用无法启动**:
```bash
# 检查端口占用
lsof -i :8081

# 检查日志
tail -100 /var/log/bankshield/application.log

# 检查配置文件
cat /opt/bankshield/config/application-prod.yml
```

**数据库连接失败**:
```bash
# 检查MySQL状态
systemctl status mysqld

# 测试连接
mysql -u bankshield -p -h localhost

# 检查防火墙
firewall-cmd --list-all
```

**内存溢出**:
```bash
# 调整JVM参数
java -Xms2g -Xmx4g -jar bankshield-api.jar
```

---

## 9. 安全加固

### 9.1 防火墙配置

```bash
# 开放必要端口
firewall-cmd --permanent --add-port=80/tcp
firewall-cmd --permanent --add-port=443/tcp
firewall-cmd --permanent --add-port=8081/tcp
firewall-cmd --reload
```

### 9.2 SSL证书配置

```bash
# 使用Let's Encrypt
certbot --nginx -d bankshield.com
```

### 9.3 定期更新

```bash
# 更新系统
sudo yum update -y

# 更新应用
./scripts/deploy.sh --update
```

---

**文档结束**

**编写人**: BankShield DevOps Team  
**审核人**: ________________  日期: ________
