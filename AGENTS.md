# BankShield é¡¹ç›®å¼€å‘æŒ‡å—

## é¡¹ç›®æ¦‚è§ˆ

BankShield æ˜¯ä¸€ä¸ªä¸“ä¸šçš„é“¶è¡Œæ•°æ®å®‰å…¨ç®¡ç†å¹³å°ï¼Œé‡‡ç”¨å¾®æœåŠ¡æ¶æ„ï¼Œæä¾›æ•°æ®åŠ å¯†ã€è®¿é—®æ§åˆ¶ã€å®¡è®¡è¿½è¸ªã€æ•æ„Ÿæ•°æ®è¯†åˆ«ä¸è„±æ•ç­‰æ ¸å¿ƒåŠŸèƒ½ï¼Œç¡®ä¿é“¶è¡Œæ•°æ®å…¨ç”Ÿå‘½å‘¨æœŸçš„å®‰å…¨æ€§ã€‚

### æ ¸å¿ƒåŠŸèƒ½æ¨¡å—
- ğŸ” **æ•°æ®åŠ å¯†ç®¡ç†** - æ”¯æŒå›½å¯†SM2/SM3/SM4ç®—æ³•å’Œå›½é™…æ ‡å‡†åŠ å¯†ç®—æ³•
- ğŸ‘¥ **ç»†ç²’åº¦è®¿é—®æ§åˆ¶** - åŸºäºRBACçš„æƒé™ç®¡ç†ä½“ç³»ï¼Œæ”¯æŒè§’è‰²äº’æ–¥
- ğŸ“Š **å®æ—¶å®¡è®¡è¿½è¸ª** - å…¨é“¾è·¯æ“ä½œæ—¥å¿—è®°å½•ä¸åˆ†æ
- ğŸ¯ **æ•æ„Ÿæ•°æ®è¯†åˆ«** - è‡ªåŠ¨å‘ç°å’Œåˆ†ç±»æ•æ„Ÿæ•°æ®
- ğŸ­ **æ™ºèƒ½æ•°æ®è„±æ•** - åŠ¨æ€å’Œé™æ€æ•°æ®è„±æ•
- ğŸ“ˆ **å®‰å…¨æ€åŠ¿å¯è§†åŒ–** - å®æ—¶å®‰å…¨ç›‘æ§ä¸å‘Šè­¦
- ğŸ“‹ **åˆè§„æ€§æ£€æŸ¥** - ç¬¦åˆé‡‘èè¡Œä¸šæ ‡å‡†è§„èŒƒ
- ğŸ” **æ•°æ®è¡€ç¼˜è¿½è¸ª** - å…¨é“¾è·¯æ•°æ®æµå‘è¿½è¸ª
- ğŸ’§ **æ•°å­—æ°´å°** - æ–‡æ¡£æº¯æºå’Œç‰ˆæƒä¿æŠ¤
- ğŸ›¡ï¸ **å®‰å…¨æ‰«æ** - è‡ªåŠ¨åŒ–æ¼æ´æ£€æµ‹

## æŠ€æœ¯æ ˆ

### åç«¯æŠ€æœ¯æ ˆ
- **æ¡†æ¶**: Spring Boot 2.7.18 + Spring Cloud 2021.0.8
- **å¾®æœåŠ¡**: Spring Cloud Alibaba 2021.0.5.0
- **å®‰å…¨**: Spring Security + JWT Tokenè®¤è¯
- **æ•°æ®åº“**: MyBatis-Plus 3.5.3.2 + MySQL 8.0
- **è¿æ¥æ± **: Druid 1.2.20
- **ç¼“å­˜**: Redis + Redisson 3.17.7ï¼ˆåˆ†å¸ƒå¼é™æµï¼‰
- **å›½å¯†ç®—æ³•**: Bouncy Castle 1.70ï¼ˆSM2/SM3/SM4ï¼‰
- **å·¥å…·åº“**: Lombok 1.18.30 + Hutool 5.8.28
- **JSONå¤„ç†**: FastJSON2 2.0.43
- **Excelå¤„ç†**: EasyExcel 3.3.4
- **å®šæ—¶ä»»åŠ¡**: Quartz
- **WebSocket**: Spring WebSocketï¼ˆå®æ—¶å‘Šè­¦ï¼‰
- **å›½å¯†SSL**: TLCP-SSL 1.0.0
- **ä¿é™©åº“**: Spring Vault 2.3.2ï¼ˆå¯†é’¥ç®¡ç†ï¼‰

### å‰ç«¯æŠ€æœ¯æ ˆ
- **æ¡†æ¶**: Vue 3.5.26 + TypeScript 5.3.3
- **UIç»„ä»¶**: Element Plus 2.13.0
- **å›¾æ ‡**: @element-plus/icons-vue 2.3.2
- **çŠ¶æ€ç®¡ç†**: Pinia 2.3.1
- **è·¯ç”±**: Vue Router 4.6.4
- **HTTPå®¢æˆ·ç«¯**: Axios 1.13.2
- **å›¾è¡¨**: ECharts 5.6.0
- **æ—¥æœŸå¤„ç†**: Dayjs 1.11.19
- **Cookie**: JS Cookie 3.0.5
- **è¿›åº¦æ¡**: NProgress 0.2.0
- **æ„å»ºå·¥å…·**: Vite 5.0.10
- **ä»£ç è§„èŒƒ**: ESLint + Prettier + TypeScriptä¸¥æ ¼æ¨¡å¼

### åŸºç¡€è®¾æ–½
- **å®¹å™¨åŒ–**: Docker + Docker Compose
- **ç¼–æ’**: Kubernetes + Helm Charts
- **æœåŠ¡ç½‘æ ¼**: Spring Cloud Gatewayï¼ˆAPIç½‘å…³ï¼‰
- **æœåŠ¡å‘ç°**: Netflix Eureka
- **é…ç½®ä¸­å¿ƒ**: Spring Cloud Config
- **è´Ÿè½½å‡è¡¡**: Spring Cloud LoadBalancer
- **ç†”æ–­é™çº§**: Sentinel
- **ç›‘æ§**: Prometheus + Grafana + Alertmanager
- **CI/CD**: GitHub Actions + Jenkins + ArgoCDï¼ˆGitOpsï¼‰
- **ä»£ç è´¨é‡**: SonarQube + JaCoCoï¼ˆè¦†ç›–ç‡>80%ï¼‰
- **å®‰å…¨æ‰«æ**: OWASP Dependency Check + Trivyï¼ˆCVEè¯„åˆ†>7å¤±è´¥ï¼‰

## é¡¹ç›®ç»“æ„

```
BankShield/
â”œâ”€â”€ bankshield-parent/              # çˆ¶POMï¼Œç»Ÿä¸€ç®¡ç†ä¾èµ–ç‰ˆæœ¬
â”œâ”€â”€ bankshield-common/              # å…¬å…±æ¨¡å—ï¼ˆå·¥å…·ç±»ã€å…¬å…±å®ä½“ã€å¼‚å¸¸å¤„ç†ï¼‰
â”œâ”€â”€ bankshield-api/                 # æ ¸å¿ƒä¸šåŠ¡æœåŠ¡ï¼ˆä¸»åº”ç”¨ï¼‰
â”œâ”€â”€ bankshield-auth/                # è®¤è¯æˆæƒæœåŠ¡
â”œâ”€â”€ bankshield-gateway/             # APIç½‘å…³ï¼ˆè·¯ç”±ã€é™æµã€é‰´æƒï¼‰
â”œâ”€â”€ bankshield-encrypt/             # åŠ å¯†ç»„ä»¶ï¼ˆå›½å¯†ç®—æ³•å°è£…ï¼‰
â”œâ”€â”€ bankshield-monitor/             # ç›‘æ§æœåŠ¡é›†æˆ
â”œâ”€â”€ bankshield-ai/                  # AIæ™ºèƒ½è¯†åˆ«æ¨¡å—
â”œâ”€â”€ bankshield-lineage/             # æ•°æ®è¡€ç¼˜æ¨¡å—
â”œâ”€â”€ bankshield-blockchain/          # åŒºå—é“¾å­˜è¯æ¨¡å—
â”œâ”€â”€ bankshield-mpc/                 # å¤šæ–¹è®¡ç®—æ¨¡å—
â”œâ”€â”€ bankshield-ui/                  # å‰ç«¯Vueåº”ç”¨
â”œâ”€â”€ bankshield-demo/                # æ¼”ç¤ºæ¨¡å—
â”œâ”€â”€ sql/                            # æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
â”œâ”€â”€ scripts/                        # è‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆå¯åŠ¨ã€éƒ¨ç½²ã€å¥åº·æ£€æŸ¥ï¼‰
â”œâ”€â”€ docker/                         # Dockeré…ç½®å’ŒDocker Composeæ–‡ä»¶
â”œâ”€â”€ k8s/                            # Kuberneteséƒ¨ç½²é…ç½®ï¼ˆdev/preview/prodï¼‰
â”œâ”€â”€ helm/                           # Helm Chartsé…ç½®
â”œâ”€â”€ argocd/                         # ArgoCD GitOpsé…ç½®
â”œâ”€â”€ monitoring/                     # ç›‘æ§å‘Šè­¦é…ç½®
â”œâ”€â”€ docs/                           # é¡¹ç›®æ–‡æ¡£
â”œâ”€â”€ tests/                          # æµ‹è¯•è„šæœ¬ï¼ˆæ€§èƒ½æµ‹è¯•ã€E2Eæµ‹è¯•ï¼‰
â””â”€â”€ reports/                        # æµ‹è¯•æŠ¥å‘Šå’Œæ‰«æç»“æœ
```

## æ„å»ºä¸æµ‹è¯•å‘½ä»¤

### åç«¯æ„å»º

```bash
# å®Œæ•´æ„å»ºï¼ˆè·³è¿‡æµ‹è¯•ï¼‰
mvn clean install -DskipTests

# ä»…æ„å»ºAPIæ¨¡å—
cd bankshield-api
mvn clean package -DskipTests

# æ„å»ºå¹¶æ‰§è¡Œå•å…ƒæµ‹è¯•
mvn clean test

# æ„å»ºå¹¶æ‰§è¡Œé›†æˆæµ‹è¯•
mvn clean verify -Dspring.profiles.active=test

# æ„å»ºç”Ÿäº§ç¯å¢ƒJARï¼ˆåŒ…å«æ‰€æœ‰ä¾èµ–ï¼‰
mvn clean package -Pprod

# ä»£ç è¦†ç›–ç‡æ£€æŸ¥ï¼ˆè¦æ±‚>80%ï¼‰
mvn jacoco:prepare-agent test jacoco:report

# SonarQubeä»£ç è´¨é‡åˆ†æ
mvn sonar:sonar \
  -Dsonar.projectKey=bankshield \
  -Dsonar.host.url=http://localhost:9000 \
  -Dsonar.login=YOUR_TOKEN

# ä¾èµ–å®‰å…¨æ¼æ´æ‰«æï¼ˆCVEè¯„åˆ†>7å¤±è´¥ï¼‰
mvn dependency-check:check
```

### å‰ç«¯æ„å»º

```bash
# å®‰è£…ä¾èµ–
cd bankshield-ui
npm install

# å¼€å‘æœåŠ¡å™¨ï¼ˆå¸¦çƒ­é‡è½½ï¼‰
npm run dev

# ç”Ÿäº§æ„å»º
npm run build

# ä»…TypeScriptç±»å‹æ£€æŸ¥
cd bankshield-ui
npm run type-check

# ä»£ç æ ¼å¼åŒ–å’ŒLint
npm run format
npm run lint

# å•å…ƒæµ‹è¯•
npm run test

# E2Eæµ‹è¯•
npm run test:e2e
```

### å®Œæ•´é¡¹ç›®å¯åŠ¨

```bash
# æ–¹å¼ä¸€ï¼šä½¿ç”¨å¯åŠ¨è„šæœ¬ï¼ˆæ¨èï¼‰
./scripts/start.sh --dev      # å¯åŠ¨å¼€å‘ç¯å¢ƒ
./scripts/start.sh --prod     # å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ
./scripts/start.sh --build    # ä»…æ„å»ºé¡¹ç›®
./scripts/start.sh --stop     # åœæ­¢æ‰€æœ‰æœåŠ¡
./scripts/start.sh --help     # æŸ¥çœ‹å¸®åŠ©

# æ–¹å¼äºŒï¼šæ‰‹åŠ¨å¯åŠ¨
mysql -u root -p < sql/init_database.sql    # åˆå§‹åŒ–æ•°æ®åº“
cd bankshield-api && mvn spring-boot:run    # å¯åŠ¨åç«¯
cd bankshield-ui && npm run dev             # å¯åŠ¨å‰ç«¯
```

### Dockeréƒ¨ç½²

```bash
# æ„å»ºé•œåƒ
docker build -t bankshield/api:latest ./bankshield-api
docker build -t bankshield/ui:latest ./bankshield-ui

# ä½¿ç”¨Docker Composeå¯åŠ¨
cd docker
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f api
docker-compose logs -f ui
```

### Kuberneteséƒ¨ç½²

```bash
# éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
kubectl apply -f k8s/dev/

# éƒ¨ç½²åˆ°é¢„è§ˆç¯å¢ƒï¼ˆPRï¼‰
kubectl apply -f k8s/preview/

# éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼ˆè°¨æ…æ“ä½œï¼‰
kubectl apply -f k8s/prod/

# æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€
kubectl get pods -n bankshield-dev
kubectl get pods -n bankshield-prod

# ä½¿ç”¨Helméƒ¨ç½²
helm install bankshield ./helm/bankshield -n bankshield-prod
```

## ä»£ç ç»„ç»‡è§„èŒƒ

### åç«¯ä»£ç ç»“æ„ï¼ˆbankshield-apiï¼‰

```
src/main/java/com/bankshield/api/
â”œâ”€â”€ annotation/           # è‡ªå®šä¹‰æ³¨è§£ï¼ˆ@RoleExclusiveã€@MaskDataï¼‰
â”œâ”€â”€ aspect/               # AOPåˆ‡é¢ï¼ˆæ•°æ®è„±æ•ã€è§’è‰²æ£€æŸ¥ï¼‰
â”œâ”€â”€ config/               # é…ç½®ç±»ï¼ˆRedisã€Vaultã€å¼‚æ­¥çº¿ç¨‹æ± ï¼‰
â”œâ”€â”€ controller/           # REST APIæ§åˆ¶å™¨ï¼ˆæŒ‰ä¸šåŠ¡æ¨¡å—ç»„ç»‡ï¼‰
â”œâ”€â”€ service/              # æœåŠ¡å±‚æ¥å£
â”‚   â””â”€â”€ impl/             # æœåŠ¡å±‚å®ç°
â”œâ”€â”€ service/lineage/      # æ•°æ®è¡€ç¼˜ä¸“é¡¹æœåŠ¡
â”œâ”€â”€ mapper/               # MyBatis Mapperæ¥å£
â”œâ”€â”€ entity/               # å®ä½“ç±»ï¼ˆå¯¹åº”æ•°æ®åº“è¡¨ï¼‰
â”œâ”€â”€ dto/                  # æ•°æ®ä¼ è¾“å¯¹è±¡
â”œâ”€â”€ enums/                # æšä¸¾ç±»ï¼ˆçŠ¶æ€ã€ç±»å‹ã€çº§åˆ«ï¼‰
â”œâ”€â”€ job/                  # å®šæ—¶ä»»åŠ¡ï¼ˆQuartzï¼‰
â”œâ”€â”€ websocket/            # WebSocketå¤„ç†å™¨
â”œâ”€â”€ filter/               # è¿‡æ»¤å™¨ï¼ˆé™æµã€å®‰å…¨ï¼‰
â”œâ”€â”€ interceptor/          # æ‹¦æˆªå™¨ï¼ˆå®¡è®¡æ—¥å¿—ï¼‰
â”œâ”€â”€ component/            # é€šç”¨ç»„ä»¶
â””â”€â”€ BankShieldApiApplication.java  # å¯åŠ¨ç±»

src/main/resources/
â”œâ”€â”€ application.yml       # ä¸»é…ç½®æ–‡ä»¶
â”œâ”€â”€ application-dev.yml   # å¼€å‘ç¯å¢ƒé…ç½®
â”œâ”€â”€ application-test.yml  # æµ‹è¯•ç¯å¢ƒé…ç½®
â”œâ”€â”€ application-prod.yml  # ç”Ÿäº§ç¯å¢ƒé…ç½®
â”œâ”€â”€ mapper/               # MyBatis XMLæ˜ å°„æ–‡ä»¶
â””â”€â”€ static/               # é™æ€èµ„æº
```

### å‰ç«¯ä»£ç ç»“æ„ï¼ˆbankshield-uiï¼‰

```
src/
â”œâ”€â”€ api/                  # APIæ¥å£å°è£…ï¼ˆæŒ‰æ¨¡å—ç»„ç»‡ï¼‰
â”œâ”€â”€ assets/               # é™æ€èµ„æºï¼ˆå›¾ç‰‡ã€å›¾æ ‡ï¼‰
â”œâ”€â”€ components/           # Vueç»„ä»¶ï¼ˆé€šç”¨ç»„ä»¶ï¼‰
â”œâ”€â”€ router/               # è·¯ç”±é…ç½®
â”œâ”€â”€ store/                # PiniaçŠ¶æ€ç®¡ç†ï¼ˆæŒ‰æ¨¡å—ï¼‰
â”œâ”€â”€ types/                # TypeScriptç±»å‹å®šä¹‰
â”œâ”€â”€ utils/                # å·¥å…·å‡½æ•°ï¼ˆè¯·æ±‚å°è£…ã€åŠ å¯†ã€éªŒè¯ï¼‰
â”œâ”€â”€ views/                # é¡µé¢ç»„ä»¶ï¼ˆæŒ‰åŠŸèƒ½æ¨¡å—ï¼‰
â”œâ”€â”€ hooks/                # Vue Composition APIé’©å­
â”œâ”€â”€ directives/           # Vueè‡ªå®šä¹‰æŒ‡ä»¤
â”œâ”€â”€ plugins/              # Vueæ’ä»¶
â”œâ”€â”€ styles/               # å…¨å±€æ ·å¼
â””â”€â”€ App.vue               # æ ¹ç»„ä»¶
```

### æ•°æ®åº“å‘½åè§„èŒƒ

```sql
-- è¡¨å‘½å
sys_user                    -- ç³»ç»Ÿè¡¨åŠ sys_å‰ç¼€
monitor_metric              -- ä¸šåŠ¡è¡¨ä½¿ç”¨æ¨¡å—åå‰ç¼€
rel_user_role               -- å…³è”è¡¨ä½¿ç”¨rel_å‰ç¼€

-- å­—æ®µå‘½å
id                          -- ä¸»é”®ç»Ÿä¸€ä¸ºid
create_time                 -- æ—¶é—´å­—æ®µåŠ _timeåç¼€
alert_status                -- çŠ¶æ€å­—æ®µåŠ _statusåç¼€
rule_id                     -- å¤–é”®åŠ _idåç¼€

-- ç´¢å¼•å‘½å
idx_username                -- æ™®é€šç´¢å¼•
uk_email                    -- å”¯ä¸€ç´¢å¼•
```

## å¼€å‘è§„èŒƒ

### 1. åç«¯å¼€å‘è§„èŒƒ

#### ä»£ç æ ¼å¼
- éµå¾ªé˜¿é‡Œå·´å·´Javaå¼€å‘æ‰‹å†Œ
- ä½¿ç”¨Lombokç®€åŒ–ä»£ç ï¼ˆ@Dataã€@Slf4jï¼‰
- Serviceå±‚æ¥å£å®šä¹‰åœ¨`service`åŒ…ï¼Œå®ç°åœ¨`service.impl`åŒ…
- Controllerç»Ÿä¸€è¿”å›`Result<T>`å¯¹è±¡
- ä½¿ç”¨`@Slf4j`æ³¨è§£è®°å½•æ—¥å¿—

#### APIè®¾è®¡
```java
@RestController
@RequestMapping("/api/users")
public class UserController {
    
    @GetMapping("/{id}")
    public Result<User> getUser(@PathVariable Long id) {
        try {
            User user = userService.getById(id);
            return Result.success(user);
        } catch (Exception e) {
            log.error("æŸ¥è¯¢ç”¨æˆ·å¤±è´¥: {}", e.getMessage(), e);
            return Result.error("æŸ¥è¯¢ç”¨æˆ·å¤±è´¥");
        }
    }
    
    @PostMapping
    public Result<Void> createUser(@RequestBody @Valid UserDTO userDTO) {
        userService.createUser(userDTO);
        return Result.success();
    }
}
```

#### å¼‚å¸¸å¤„ç†
- è‡ªå®šä¹‰å¼‚å¸¸ç»§æ‰¿`RuntimeException`
- å…¨å±€å¼‚å¸¸å¤„ç†å™¨ç»Ÿä¸€å¤„ç†
- æ•æ„Ÿä¿¡æ¯ä¸è¿”å›ç»™å‰ç«¯

#### å›½å¯†ç®—æ³•ä½¿ç”¨
```java
// SM2éå¯¹ç§°åŠ å¯†
SM2KeyPair keyPair = Sm2Util.generateKeyPair();
String encrypted = Sm2Util.encrypt(data, keyPair.getPublicKey());
String decrypted = Sm2Util.decrypt(encrypted, keyPair.getPrivateKey());

// SM3æ‚å‡‘ç®—æ³•
String hash = Sm3Util.hash(data);
boolean isValid = Sm3Util.verify(data, hash);

// SM4å¯¹ç§°åŠ å¯†
String key = Sm4Util.generateKey();
String encrypted = Sm4Util.encrypt(data, key);
String decrypted = Sm4Util.decrypt(encrypted, key);
```

### 2. å‰ç«¯å¼€å‘è§„èŒƒ

#### TypeScriptä¸¥æ ¼æ¨¡å¼
- æ‰€æœ‰å˜é‡å¿…é¡»å£°æ˜ç±»å‹
- æ¥å£å’Œç±»å‹å®šä¹‰æ”¾åœ¨`@/types`ç›®å½•
- ä½¿ç”¨`interface`å®šä¹‰å¯¹è±¡ç»“æ„
- ä½¿ç”¨`enum`å®šä¹‰æšä¸¾å€¼

#### Vueç»„ä»¶è§„èŒƒ
```vue
<script setup lang="ts">
import { ref, computed } from 'vue'
import type { User } from '@/types/user'

// å®šä¹‰Props
interface Props {
  userId: string
}

const props = defineProps<Props>()

// å®šä¹‰Emits
const emit = defineEmits<{
  (e: 'update', user: User): void
}>()

// å“åº”å¼æ•°æ®
const loading = ref(false)
const user = ref<User | null>(null)

// è®¡ç®—å±æ€§
const fullName = computed(() => {
  return user.value ? `${user.value.firstName} ${user.value.lastName}` : ''
})
</script>

<template>
  <div class="user-detail">
    <el-card v-loading="loading">
      <h2>{{ fullName }}</h2>
    </el-card>
  </div>
</template>

<style scoped lang="less">
.user-detail {
  padding: 20px;
}
</style>
```

#### APIæ¥å£è§„èŒƒ
```typescript
// api/user.ts
import request from '@/utils/request'
import type { User, UserForm } from '@/types/user'

export const getUser = (id: string): Promise<User> => {
  return request.get(`/users/${id}`)
}

export const createUser = (data: UserForm): Promise<void> => {
  return request.post('/users', data)
}

export const updateUser = (id: string, data: UserForm): Promise<void> => {
  return request.put(`/users/${id}`, data)
}

export const deleteUser = (id: string): Promise<void> => {
  return request.delete(`/users/${id}`)
}
```

#### çŠ¶æ€ç®¡ç†ï¼ˆPiniaï¼‰
```typescript
// store/user.ts
import { defineStore } from 'pinia'
import type { User } from '@/types/user'

export const useUserStore = defineStore('user', {
  state: () => ({
    users: [] as User[],
    loading: false
  }),
  
  getters: {
    activeUsers: (state) => state.users.filter(u => u.status === 'active')
  },
  
  actions: {
    async fetchUsers() {
      this.loading = true
      try {
        this.users = await api.getUsers()
      } finally {
        this.loading = false
      }
    }
  }
})
```

### 3. æ•°æ®åº“è®¾è®¡è§„èŒƒ

#### MyBatis-Plusä½¿ç”¨
```java
// Mapperæ¥å£
public interface UserMapper extends BaseMapper<User> {
    @Select("SELECT * FROM sys_user WHERE dept_id = #{deptId}")
    List<User> selectByDeptId(@Param("deptId") Long deptId);
}

// Serviceå®ç°
@Service
public class UserServiceImpl extends ServiceImpl<UserMapper, User> implements UserService {
    @Override
    public List<User> getUsersByDept(Long deptId) {
        return baseMapper.selectByDeptId(deptId);
    }
}
```

#### ç´¢å¼•ä¼˜åŒ–åŸåˆ™
- æŸ¥è¯¢æ¡ä»¶å­—æ®µå¿…é¡»å»ºç«‹ç´¢å¼•
- å¤–é”®å­—æ®µå¿…é¡»å»ºç«‹ç´¢å¼•
- æ’åºå­—æ®µå»ºè®®å»ºç«‹ç´¢å¼•
- ç»„åˆç´¢å¼•éµå¾ªæœ€å·¦å‰ç¼€åŸåˆ™
- å®šæœŸåˆ†æå’Œä¼˜åŒ–ç´¢å¼•

## æµ‹è¯•ç­–ç•¥

### 1. å•å…ƒæµ‹è¯•

#### æµ‹è¯•æ¡†æ¶é…ç½®
```java
// JUnit 5 + Mockito
@SpringBootTest
@ExtendWith(MockitoExtension.class)
class UserServiceTest {
    
    @Mock
    private UserMapper userMapper;
    
    @InjectMocks
    private UserServiceImpl userService;
    
    @Test
    void testGetUserById() {
        // Arrange
        User mockUser = new User();
        mockUser.setId(1L);
        mockUser.setUsername("test");
        when(userMapper.selectById(1L)).thenReturn(mockUser);
        
        // Act
        User result = userService.getById(1L);
        
        // Assert
        assertNotNull(result);
        assertEquals("test", result.getUsername());
        verify(userMapper, times(1)).selectById(1L);
    }
}
```

#### è¦†ç›–ç‡è¦æ±‚
- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘è¦†ç›–ç‡å¿…é¡»è¾¾åˆ°100%
- Serviceå±‚è¦†ç›–ç‡ä¸ä½äº90%
- Controllerå±‚è¦†ç›–ç‡ä¸ä½äº80%
- æ•´ä½“è¦†ç›–ç‡ä¸ä½äº80%ï¼ˆJaCoCoå¼ºåˆ¶æ‰§è¡Œï¼‰

### 2. é›†æˆæµ‹è¯•

```java
@SpringBootTest(webEnvironment = WebEnvironment.RANDOM_PORT)
@ActiveProfiles("test")
@Testcontainers
class UserControllerIntegrationTest {
    
    @Container
    static MySQLContainer<?> mysql = new MySQLContainer<>("mysql:8.0");
    
    @Autowired
    private TestRestTemplate restTemplate;
    
    @Test
    void testCreateUser() {
        UserDTO userDTO = new UserDTO();
        userDTO.setUsername("integration");
        userDTO.setName("é›†æˆæµ‹è¯•");
        
        ResponseEntity<Result> response = restTemplate.postForEntity(
            "/api/users", userDTO, Result.class);
        
        assertEquals(HttpStatus.OK, response.getStatusCode());
        assertEquals(200, response.getBody().getCode());
    }
}
```

### 3. ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆE2Eï¼‰

#### Cypressæµ‹è¯•
```javascript
// cypress/integration/login.spec.js
describe('ç™»å½•åŠŸèƒ½æµ‹è¯•', () => {
  it('æˆåŠŸç™»å½•', () => {
    cy.visit('/login')
    cy.get('[data-test="username"]').type('admin')
    cy.get('[data-test="password"]').type('123456')
    cy.get('[data-test="login-button"]').click()
    cy.url().should('include', '/dashboard')
    cy.get('[data-test="user-menu"]').should('contain', 'admin')
  })
  
  it('ç™»å½•å¤±è´¥', () => {
    cy.visit('/login')
    cy.get('[data-test="username"]').type('admin')
    cy.get('[data-test="password"]').type('wrong')
    cy.get('[data-test="login-button"]').click()
    cy.get('[data-test="error-message"]').should('be.visible')
  })
})
```

### 4. æ€§èƒ½æµ‹è¯•

#### k6æµ‹è¯•è„šæœ¬
```javascript
// tests/k6/bankshield-load-test.js
import http from 'k6/http';
import { check, sleep } from 'k6';

export const options = {
  stages: [
    { duration: '2m', target: 100 },
    { duration: '5m', target: 100 },
    { duration: '2m', target: 200 },
    { duration: '5m', target: 200 },
    { duration: '2m', target: 0 },
  ],
  thresholds: {
    http_req_duration: ['p(95)<200'],
    http_req_failed: ['rate<0.01'],
  },
};

const BASE_URL = 'http://localhost:8080/api';
const USERNAME = 'admin';
const PASSWORD = '123456';

export default function () {
  const loginRes = http.post(`${BASE_URL}/auth/login`, {
    username: USERNAME,
    password: PASSWORD,
  });
  
  check(loginRes, { 'ç™»å½•æˆåŠŸ': (r) => r.status === 200 });
  
  const authHeaders = {
    headers: {
      Authorization: `Bearer ${loginRes.json('token')}`,
    },
  };
  
  const myObjects = http.get(`${BASE_URL}/users`, authHeaders);
  check(myObjects, { 'è·å–ç”¨æˆ·åˆ—è¡¨': (r) => r.status === 200 });
  
  sleep(1);
}
```

### 5. APIæµ‹è¯•ï¼ˆRestAssuredï¼‰

```java
class AlertRuleApiTest {
    
    @Test
    void testCreateAlertRule() {
        String jsonBody = "{"
            + "\"ruleName\":\"CPUå‘Šè­¦\","
            + "\"metricType\":\"CPU_USAGE\","
            + "\"condition\":\">\","
            + "\"threshold\":80,"
            + "\"alertLevel\":\"WARNING\","
            + "\"enabled\":true"
            + "}";
        
        given()
            .auth().oauth2(token)
            .contentType(ContentType.JSON)
            .body(jsonBody)
        .when()
            .post("/api/alert-rules")
        .then()
            .statusCode(200)
            .body("code", equalTo(200))
            .body("data.ruleName", equalTo("CPUå‘Šè­¦"));
    }
}
```

### 6. æµ‹è¯•æ‰§è¡Œå‘½ä»¤æ±‡æ€»

```bash
# å•å…ƒæµ‹è¯•
mvn test -Dtest=**/*UnitTest.java

# é›†æˆæµ‹è¯•
mvn verify -Dspring.profiles.active=test

# æ‰€æœ‰æµ‹è¯•
mvn clean verify

# å‰ç«¯å•å…ƒæµ‹è¯•
cd bankshield-ui && npm run test:unit

# E2Eæµ‹è¯•
cd bankshield-ui && npm run test:e2e

# æ€§èƒ½æµ‹è¯•
cd tests/k6 && k6 run bankshield-load-test.js

# ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
mvn allure:serve    # æŸ¥çœ‹Allureæµ‹è¯•æŠ¥å‘Š
```

## å®‰å…¨è§„èŒƒ

### 1. è®¤è¯æˆæƒ

#### JWTè®¤è¯æµç¨‹
```java
// JWTè¿‡æ»¤å™¨
@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    
    @Override
    protected void doFilterInternal(HttpServletRequest request, 
                                   HttpServletResponse response, 
                                   FilterChain chain) 
            throws ServletException, IOException {
        
        String token = getTokenFromRequest(request);
        
        if (StringUtils.hasText(token) && jwtTokenUtil.validateToken(token)) {
            String username = jwtTokenUtil.getUsernameFromToken(token);
            UserDetails userDetails = userDetailsService.loadUserByUsername(username);
            
            UsernamePasswordAuthenticationToken authentication = 
                new UsernamePasswordAuthenticationToken(
                    userDetails, null, userDetails.getAuthorities());
            authentication.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
            
            SecurityContextHolder.getContext().setAuthentication(authentication);
        }
        
        chain.doFilter(request, response);
    }
}
```

#### è§’è‰²äº’æ–¥æ³¨è§£
```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface RoleExclusive {
    String value();  // äº’æ–¥è§’è‰²ç»„æ ‡è¯†
}

// ä½¿ç”¨ç¤ºä¾‹
@RoleExclusive("risk-management")
@DeleteMapping("/high-risk-data")
public Result<Void> deleteHighRiskData(@PathVariable Long id) {
    // è¯¥æ–¹æ³•ä¸å…è®¸é£é™©ç®¡ç†ç»„çš„å…¶ä»–è§’è‰²åŒæ—¶è®¿é—®
}
```

### 2. æ•°æ®åŠ å¯†

#### å›½å¯†ç®—æ³•ä½¿ç”¨è§„èŒƒ
```java
// SM2å…¬é’¥åŠ å¯†ï¼ˆç”¨äºå¯†é’¥äº¤æ¢ï¼‰
@Service
public class SecureKeyManagementService {
    
    public String encryptWithSm2(String data, String publicKey) {
        return Sm2Util.encrypt(data, publicKey);
    }
    
    public String decryptWithSm2(String encryptedData, String privateKey) {
        return Sm2Util.decrypt(encryptedData, privateKey);
    }
}

// SM4å¯¹ç§°åŠ å¯†ï¼ˆç”¨äºæ•°æ®åŠ å¯†ï¼‰
@Service
public class DataEncryptionService {
    
    public String encryptWithSm4(String data, String key) {
        return Sm4Util.encrypt(data, key);
    }
    
    public String decryptWithSm4(String encryptedData, String key) {
        return Sm4Util.decrypt(encryptedData, key);
    }
}

// SM3æ‚å‡‘ç®—æ³•ï¼ˆç”¨äºå®Œæ•´æ€§æ ¡éªŒï¼‰
@Service
public class IntegrityVerificationService {
    
    public String hashWithSm3(String data) {
        return Sm3Util.hash(data);
    }
    
    public boolean verifyIntegrity(String data, String hash) {
        return Sm3Util.verify(data, hash);
    }
}
```

#### å­—æ®µçº§åŠ å¯†
```java
@Entity
@Table(name = "sys_user")
public class User {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(name = "username")
    private String username;
    
    @Column(name = "phone")
    @SensitiveField(type = SensitiveType.PHONE)  // æ•æ„Ÿå­—æ®µæ³¨è§£
    private String phone;  // è‡ªåŠ¨åŠ å¯†å­˜å‚¨
    
    @Column(name = "id_card")
    @SensitiveField(type = SensitiveType.ID_CARD)
    private String idCard;  // è‡ªåŠ¨åŠ å¯†å­˜å‚¨
}
```

### 3. æ•°æ®è„±æ•

#### æ³¨è§£å¼è„±æ•
```java
@Data
public class UserDTO {
    
    private Long id;
    
    private String username;
    
    @MaskData(type = MaskType.PHONE)  // æ‰‹æœºå·è„±æ• 138****8888
    private String phone;
    
    @MaskData(type = MaskType.ID_CARD)  // èº«ä»½è¯è„±æ• 1101**********1234
    private String idCard;
    
    @MaskData(type = MaskType.BANK_CARD)  // é“¶è¡Œå¡è„±æ• 6222**********5678
    private String bankCard;
}
```

#### åŠ¨æ€è„±æ•
```java
@Service
public class DataMaskingEngine {
    
    public <T> T maskData(T data, UserRole viewerRole) {
        // æ ¹æ®æŸ¥çœ‹è€…è§’è‰²å†³å®šè„±æ•çº§åˆ«
        MaskingLevel level = determineMaskingLevel(viewerRole);
        return applyMasking(data, level);
    }
}
```

### 4. è¾“å…¥éªŒè¯

#### å…¨å±€éªŒè¯é…ç½®
```java
@Configuration
public class ValidationConfig {
    
    @Bean
    public Validator validator() {
        ValidatorFactory factory = Validation.byProvider(HibernateValidator.class)
            .configure()
            .failFast(true)  // å¿«é€Ÿå¤±è´¥æ¨¡å¼
            .buildValidatorFactory();
        return factory.getValidator();
    }
}
```

#### è¯·æ±‚å‚æ•°éªŒè¯
```java
@Data
public class UserCreateRequest {
    
    @NotBlank(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    @Length(min = 3, max = 50, message = "ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50ä¹‹é—´")
    @Pattern(regexp = "^[a-zA-Z0-9_]+$", message = "ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿")
    private String username;
    
    @NotBlank(message = "å¯†ç ä¸èƒ½ä¸ºç©º")
    @Length(min = 8, message = "å¯†ç é•¿åº¦è‡³å°‘8ä½")
    @Pattern(regexp = "^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z]).*$", 
             message = "å¯†ç å¿…é¡»åŒ…å«æ•°å­—ã€å¤§å°å†™å­—æ¯")
    private String password;
    
    @NotBlank(message = "æ‰‹æœºå·ä¸èƒ½ä¸ºç©º")
    @Pattern(regexp = "^1[3-9]\\d{9}$", message = "æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®")
    private String phone;
    
    @Email(message = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    private String email;
}
```

### 5. APIå®‰å…¨

#### é€Ÿç‡é™åˆ¶
```java
@Component
public class RateLimiterFilter implements GlobalFilter {
    
    private final RedissonClient redissonClient;
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        String clientId = getClientId(exchange);
        RRateLimiter rateLimiter = redissonClient.getRateLimiter(clientId);
        
        // æ¯åˆ†é’Ÿæœ€å¤š100æ¬¡è¯·æ±‚
        rateLimiter.trySetRate(RateType.OVERALL, 100, 1, RateIntervalUnit.MINUTES);
        
        if (rateLimiter.tryAcquire()) {
            return chain.filter(exchange);
        } else {
            exchange.getResponse().setStatusCode(HttpStatus.TOO_MANY_REQUESTS);
            return exchange.getResponse().setComplete();
        }
    }
}
```

#### å®‰å…¨å“åº”å¤´
```java
@Configuration
public class SecurityHeaderConfig implements WebMvcConfigurer {
    
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new HandlerInterceptor() {
            @Override
            public void postHandle(HttpServletRequest request, HttpServletResponse response, 
                                 Object handler, ModelAndView modelAndView) {
                response.addHeader("X-Content-Type-Options", "nosniff");
                response.addHeader("X-XSS-Protection", "1; mode=block");
                response.addHeader("X-Frame-Options", "DENY");
                response.addHeader("Strict-Transport-Security", "max-age=31536000; includeSubDomains");
                response.addHeader("Content-Security-Policy", "default-src 'self'");
            }
        });
    }
}
```

### 6. å¯†é’¥ç®¡ç†ï¼ˆVaulté›†æˆï¼‰

#### Vaulté…ç½®
```yaml
# application.yml
spring:
  cloud:
    vault:
      enabled: true
      host: localhost
      port: 8200
      scheme: http
      authentication: TOKEN
      token: YOUR_VAULT_TOKEN
  datasource:
    password: ${vault.secret.database.password}
  redis:
    password: ${vault.secret.redis.password}
```

#### å¯†é’¥è½®æ¢
```java
@Service
public class KeyRotationService {
    
    @Scheduled(cron = "0 0 1 * * ?")  // æ¯å¤©å‡Œæ™¨1ç‚¹æ‰§è¡Œ
    public void rotateEncryptionKeys() {
        List<SecurityKey> keys = securityKeyMapper.selectNeedRotationKeys();
        
        for (SecurityKey key : keys) {
            try {
                String newKey = generateNewKey(key.getAlgorithm());
                key.setKeyValue(newKey);
                key.setLastRotationTime(LocalDateTime.now());
                securityKeyMapper.updateById(key);
                
                log.info("å¯†é’¥è½®æ¢æˆåŠŸ: keyId={}", key.getId());
            } catch (Exception e) {
                log.error("å¯†é’¥è½®æ¢å¤±è´¥: keyId={}", key.getId(), e);
            }
        }
    }
}
```

## CI/CDæµç¨‹

### 1. GitHub Actionså·¥ä½œæµ

#### ä¸»è¦Pipeline
```yaml
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 8
        uses: actions/setup-java@v3
        with:
          java-version: '8'
          distribution: 'temurin'
      - name: Code Quality Check
        run: |
          mvn clean compile
          mvn sonar:sonar \
            -Dsonar.projectKey=bankshield \
            -Dsonar.host.url=${{ secrets.SONAR_URL }} \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}
  
  test:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: ${{ secrets.DB_PASSWORD }}
        ports:
          - 3306:3306
      redis:
        image: redis:6.0
        ports:
          - 6379:6379
    steps:
      - uses: actions/checkout@v3
      - name: Run Tests
        run: mvn clean verify
      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./target/site/jacoco/jacoco.xml
  
  build-and-push:
    needs: [code-quality, test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build Docker Images
        run: |
          docker build -t bankshield/api:${{ github.sha }} ./bankshield-api
          docker build -t bankshield/ui:${{ github.sha }} ./bankshield-ui
      - name: Security Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'bankshield/api:${{ github.sha }}'
          format: 'sarif'
      - name: Push to Registry
        run: |
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          docker push bankshield/api:${{ github.sha }}
          docker push bankshield/ui:${{ github.sha }}
```

### 2. Jenkins Pipeline

#### Jenkinsfileç¤ºä¾‹
```groovy
pipeline {
    agent any
    
    tools {
        maven 'Maven-3.8'
        jdk 'JDK-1.8'
        nodejs 'Node-16'
    }
    
    environment {
        REGISTRY = 'harbor.bankshield.com'
        DOCKER_CREDENTIALS = 'docker-hub-credentials'
        KUBE_CONFIG = 'kube-config-prod'
    }
    
    stages {
        stage('æ£€å‡º') {
            steps {
                checkout scm
            }
        }
        
        stage('ä»£ç è´¨é‡æ£€æŸ¥') {
            parallel {
                stage('SonarQubeåˆ†æ') {
                    steps {
                        withSonarQubeEnv('SonarQube') {
                            sh 'mvn clean verify sonar:sonar'
                        }
                    }
                }
                stage('ä¾èµ–æ£€æŸ¥') {
                    steps {
                        sh 'mvn dependency-check:check'
                    }
                }
            }
        }
        
        stage('æµ‹è¯•') {
            parallel {
                stage('å•å…ƒæµ‹è¯•') {
                    steps {
                        sh 'mvn clean test'
                    }
                    post {
                        always {
                            junit 'target/surefire-reports/*.xml'
                            publishHTML([
                                allowMissing: false,
                                alwaysLinkToLastBuild: true,
                                keepAll: true,
                                reportDir: 'target/site/jacoco',
                                reportFiles: 'index.html',
                                reportName: 'Coverage Report'
                            ])
                        }
                    }
                }
                stage('E2Eæµ‹è¯•') {
                    steps {
                        dir('bankshield-ui') {
                            sh 'npm install'
                            sh 'npm run test:e2e'
                        }
                    }
                }
            }
        }
        
        stage('æ„å»ºé•œåƒ') {
            steps {
                script {
                    def imageTag = "${REGISTRY}/bankshield/api:${BUILD_NUMBER}"
                    
                    docker.withRegistry("https://${REGISTRY}", DOCKER_CREDENTIALS) {
                        def apiImage = docker.build("${imageTag}", "./bankshield-api")
                        apiImage.push()
                    }
                }
            }
        }
        
        stage('éƒ¨ç½²åˆ°ç”Ÿäº§') {
            when {
                branch 'main'
            }
            steps {
                script {
                    withKubeConfig([credentialsId: KUBE_CONFIG]) {
                        sh """
                            kubectl set image deployment/bankshield-api \
                              bankshield-api=${REGISTRY}/bankshield/api:${BUILD_NUMBER} \
                              -n bankshield-prod
                            kubectl rollout status deployment/bankshield-api -n bankshield-prod
                        """
                    }
                }
            }
        }
    }
    
    post {
        always {
            cleanWs()
        }
        success {
            slackSend(
                channel: '#deployments',
                color: 'good',
                message: "âœ… BankShieldéƒ¨ç½²æˆåŠŸï¼ç‰ˆæœ¬: ${BUILD_NUMBER}"
            )
        }
        failure {
            slackSend(
                channel: '#deployments',
                color: 'danger',
                message: "âŒ BankShieldéƒ¨ç½²å¤±è´¥ï¼ç‰ˆæœ¬: ${BUILD_NUMBER}"
            )
        }
    }
}
```

### 3. ArgoCD GitOpséƒ¨ç½²

#### Applicationå®šä¹‰
```yaml
# argocd/bankshield-prod.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: bankshield-prod
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/bankshield/bankshield.git
    targetRevision: main
    path: k8s/prod
  destination:
    server: https://kubernetes.default.svc
    namespace: bankshield-prod
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
  revisionHistoryLimit: 10
```

## éƒ¨ç½²æµç¨‹

### 1. ç¯å¢ƒé…ç½®

#### å¼€å‘ç¯å¢ƒï¼ˆDevï¼‰
```bash
# åç«¯é…ç½®
SERVER_PORT=8080
SPRING_PROFILES_ACTIVE=dev
SPRING_DATASOURCE_URL=jdbc:mysql://localhost:3306/bankshield?useSSL=false
SPRING_DATASOURCE_USERNAME=root
SPRING_DATASOURCE_PASSWORD=dev_password
SPRING_REDIS_HOST=localhost
SPRING_REDIS_PORT=6379

# å‰ç«¯é…ç½®
VITE_API_BASE_URL=http://localhost:8080/api
VITE_APP_ENV=development
```

#### æµ‹è¯•ç¯å¢ƒï¼ˆTestï¼‰
```bash
# åç«¯é…ç½®
SERVER_PORT=8081
SPRING_PROFILES_ACTIVE=test
SPRING_DATASOURCE_URL=jdbc:mysql://test-db:3306/bankshield
SPRING_DATASOURCE_USERNAME=test_user
SPRING_DATASOURCE_PASSWORD=test_password_encrypted

# å‰ç«¯é…ç½®
VITE_API_BASE_URL=https://test.bankshield.com/api
VITE_APP_ENV=test
```

#### ç”Ÿäº§ç¯å¢ƒï¼ˆProdï¼‰
```bash
# åç«¯é…ç½®
SERVER_PORT=8080
SPRING_PROFILES_ACTIVE=prod
SPRING_DATASOURCE_URL=jdbc:mysql://prod-db:3306/bankshield?useSSL=true&verifyServerCertificate=true
SPRING_DATASOURCE_USERNAME=prod_user
SPRING_DATASOURCE_PASSWORD=${VAULT_SECRET}
SPRING_REDIS_PASSWORD=${VAULT_REDIS_SECRET}

# å®‰å…¨åŠ å›º
SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI=https://auth.bankshield.com
SPRING_VAULT_URI=https://vault.bankshield.com
SPRING_VAULT_TOKEN=${VAULT_TOKEN}

# å‰ç«¯é…ç½®
VITE_API_BASE_URL=https://api.bankshield.com
VITE_APP_ENV=production
```

### 2. éƒ¨ç½²è„šæœ¬

#### ä¸€é”®éƒ¨ç½²è„šæœ¬
```bash
#!/bin/bash
# scripts/deploy.sh

set -e

ENVIRONMENT=$1
VERSION=$2

if [ -z "$ENVIRONMENT" ] || [ -z "$VERSION" ]; then
    echo "Usage: ./deploy.sh <environment> <version>"
    echo "Example: ./deploy.sh prod v1.0.0"
    exit 1
fi

# è®¾ç½®Kubernetesä¸Šä¸‹æ–‡
kubectl config use-context bankshield-${ENVIRONMENT}

# æ›´æ–°é•œåƒç‰ˆæœ¬
helm upgrade bankshield ./helm/bankshield \
  --namespace bankshield-${ENVIRONMENT} \
  --set api.image.tag=${VERSION} \
  --set ui.image.tag=${VERSION} \
  --wait \
  --timeout 10m

# å¥åº·æ£€æŸ¥
./scripts/health-check.sh https://api.bankshield-${ENVIRONMENT}.com

# å‘é€é€šçŸ¥
echo "âœ… BankShield ${VERSION} éƒ¨ç½²åˆ° ${ENVIRONMENT} ç¯å¢ƒæˆåŠŸï¼"
```

#### å¥åº·æ£€æŸ¥è„šæœ¬
```bash
#!/bin/bash
# scripts/health-check.sh

API_URL=$1
MAX_RETRIES=30
RETRY_INTERVAL=10

echo "å¼€å§‹å¥åº·æ£€æŸ¥: ${API_URL}"

for i in $(seq 1 $MAX_RETRIES); do
    STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${API_URL}/actuator/health)
    
    if [ "$STATUS" == "200" ]; then
        echo "âœ… æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡ï¼"
        exit 0
    fi
    
    echo "â³ ç¬¬ $i/$MAX_RETRIES æ¬¡æ£€æŸ¥å¤±è´¥ï¼ŒçŠ¶æ€ç : $STATUS"
    sleep $RETRY_INTERVAL
done

echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œéƒ¨ç½²å›æ»š..."
exit 1
```

### 3. æ•°æ®åº“è¿ç§»

#### Flywayè¿ç§»è„šæœ¬
```sql
-- sql/V1__init_database.sql
CREATE TABLE sys_user (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    status TINYINT DEFAULT 1,
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_username(username)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·è¡¨';

-- sql/V2__encrypt_config.sql
CREATE TABLE encrypt_config (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    table_name VARCHAR(50) NOT NULL,
    column_name VARCHAR(50) NOT NULL,
    algorithm VARCHAR(20) NOT NULL COMMENT 'SM4/AES',
    key_id BIGINT NOT NULL,
    status TINYINT DEFAULT 1,
    UNIQUE KEY uk_table_column(table_name, column_name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='åŠ å¯†é…ç½®è¡¨';
```

### 4. ç›‘æ§å‘Šè­¦

#### PrometheusæŒ‡æ ‡
```yaml
# monitoring/prometheus/config.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "alert_rules.yml"

scrape_configs:
  - job_name: 'bankshield-api'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['bankshield-api:8080']
    scrape_interval: 10s

  - job_name: 'bankshield-ui'
    static_configs:
      - targets: ['bankshield-ui:80']
    scrape_interval: 30s

  - job_name: 'mysql'
    static_configs:
      - targets: ['mysql-exporter:9104']
    scrape_interval: 30s

  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']
    scrape_interval: 30s
```

#### å‘Šè­¦è§„åˆ™
```yaml
# monitoring/prometheus/alert_rules.yml
groups:
  - name: bankshield-alerts
    rules:
      - alert: HighCPUUsage
        expr: avg(rate(process_cpu_seconds_total{job="bankshield-api"}[5m])) * 100 > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "APIæœåŠ¡CPUä½¿ç”¨ç‡é«˜"
          description: "CPUä½¿ç”¨ç‡: {{ $value }}%"
      
      - alert: HighMemoryUsage
        expr: (process_resident_memory_bytes{job="bankshield-api"} / 1024 / 1024) > 1024
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "APIæœåŠ¡å†…å­˜ä½¿ç”¨é«˜"
          description: "å†…å­˜ä½¿ç”¨: {{ $value }}MB"
      
      - alert: TooManyFailedLogins
        expr: rate(bankshield_failed_login_total[5m]) > 10
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "ç™»å½•å¤±è´¥æ¬¡æ•°è¿‡å¤š"
          description: "å¯èƒ½æ­£åœ¨é­å—æš´åŠ›ç ´è§£æ”»å‡»"
      
      - alert: VaultSeal
        expr: vault_seal_status == 1
        for: 0m
        labels:
          severity: critical
        annotations:
          summary: "Vaultå·²è¢«å¯†å°"
          description: "å¯†é’¥ç®¡ç†æœåŠ¡ä¸å¯ç”¨"
```

## æ•…éšœæ’æŸ¥

### 1. å¸¸è§é—®é¢˜

#### æ•°æ®åº“è¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥MySQLæœåŠ¡çŠ¶æ€
systemctl status mysql

# æ£€æŸ¥è¿æ¥é…ç½®
cat bankshield-api/src/main/resources/application-dev.yml

# æµ‹è¯•è¿æ¥
mysql -h localhost -P 3306 -u root -p

# æŸ¥çœ‹JDBCè¿æ¥æ± çŠ¶æ€
# è®¿é—®: http://localhost:8080/api/druid/login.html
# è´¦å·: admin
# å¯†ç : 123456
```

#### Redisè¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥RedisæœåŠ¡
redis-cli ping  # åº”è¯¥è¿”å› PONG

# æ£€æŸ¥é…ç½®
redis-cli config get requirepass

# æ¸…ç©ºç¼“å­˜ï¼ˆè°¨æ…æ“ä½œï¼‰
redis-cli FLUSHALL
```

#### å‰ç«¯æ„å»ºå¤±è´¥
```bash
# æ¸…é™¤npmç¼“å­˜
cd bankshield-ui
rm -rf node_modules package-lock.json
npm cache clean --force

# é‡æ–°å®‰è£…ä¾èµ–
npm install

# æ£€æŸ¥TypeScriptç¼–è¯‘é”™è¯¯
npm run type-check
```

#### æœåŠ¡å¯åŠ¨åè®¿é—®404
```bash
# æ£€æŸ¥åç«¯æ˜¯å¦æ­£ç¡®å¯åŠ¨
curl http://localhost:8080/api/actuator/health

# æ£€æŸ¥å‰ç«¯ä»£ç†é…ç½®
cat bankshield-ui/vite.config.ts

# æ£€æŸ¥Nginxé…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
cat bankshield-ui/nginx.conf
```

### 2. æ—¥å¿—åˆ†æ

#### åç«¯æ—¥å¿—
```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
tail -f logs/api.log

# æŒ‰çº§åˆ«è¿‡æ»¤
grep "ERROR" logs/api.log

# æŸ¥çœ‹ç‰¹å®šæ—¶é—´æ®µçš„æ—¥å¿—
sed -n '/2024-01-01 10:00:00/,/2024-01-01 11:00:00/p' logs/api.log

# æŸ¥çœ‹æ…¢SQLæ—¥å¿—
# Druidç›‘æ§: http://localhost:8080/api/druid/sql.html
```

#### å‰ç«¯æ—¥å¿—
```bash
# æµè§ˆå™¨å¼€å‘è€…å·¥å…·æ§åˆ¶å°
# æŸ¥çœ‹ç½‘ç»œè¯·æ±‚: Network tab
# æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—: Console tab
# æŸ¥çœ‹åº”ç”¨çŠ¶æ€: Vue DevTools

# ç”Ÿäº§ç¯å¢ƒå‰ç«¯æ—¥å¿—
docker logs bankshield-ui-container
```

#### Dockerå®¹å™¨æ—¥å¿—
```bash
# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨
docker ps

# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs -f bankshield-api
docker logs -f bankshield-ui

# æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨
docker stats

# è¿›å…¥å®¹å™¨è°ƒè¯•
docker exec -it bankshield-api /bin/bash
```

#### Kubernetesæ—¥å¿—
```bash
# æŸ¥çœ‹Podåˆ—è¡¨
kubectl get pods -n bankshield-prod

# æŸ¥çœ‹Podæ—¥å¿—
kubectl logs -f deployment/bankshield-api -n bankshield-prod --tail=100

# æŸ¥çœ‹å…·ä½“å®¹å™¨æ—¥å¿—
kubectl logs bankshield-api-xxxx -c bankshield-api -n bankshield-prod

# æŸ¥çœ‹ServiceçŠ¶æ€
kubectl get svc -n bankshield-prod

# æŸ¥çœ‹IngressçŠ¶æ€
kubectl get ingress -n bankshield-prod
```

### 3. æ€§èƒ½è°ƒä¼˜

#### JVMè°ƒä¼˜
```bash
# å¯åŠ¨å‚æ•°ç¤ºä¾‹
java -jar \
  -Xms2g -Xmx2g \
  -XX:+UseG1GC \
  -XX:MaxGCPauseMillis=100 \
  -XX:+UseStringDeduplication \
  -Dspring.profiles.active=prod \
  bankshield-api.jar
```

#### æ•°æ®åº“è°ƒä¼˜
```sql
-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SHOW VARIABLES LIKE 'slow_query_log';
SHOW VARIABLES LIKE 'long_query_time';

-- æŸ¥çœ‹è¿æ¥æ•°
SHOW STATUS LIKE 'Threads_connected';
SHOW STATUS LIKE 'Max_used_connections';

-- æŸ¥çœ‹InnoDBçŠ¶æ€
SHOW ENGINE INNODB STATUS;

-- ä¼˜åŒ–è¡¨
OPTIMIZE TABLE sys_user;
ANALYZE TABLE sys_user;
```

#### Redisè°ƒä¼˜
```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
redis-cli INFO memory

# æŸ¥çœ‹è¿æ¥æ•°
redis-cli INFO clients

# æŸ¥çœ‹æ…¢æŸ¥è¯¢
redis-cli SLOWLOG GET 10

# é…ç½®æœ€å¤§å†…å­˜
redis-cli CONFIG SET maxmemory 4gb
redis-cli CONFIG SET maxmemory-policy allkeys-lru
```

### 4. ç›‘æ§å‘Šè­¦

#### æœåŠ¡å¥åº·æ£€æŸ¥
```bash
# Actuatorç«¯ç‚¹
curl http://localhost:8080/api/actuator/health
curl http://localhost:8080/api/actuator/info
curl http://localhost:8080/api/actuator/metrics

# è‡ªå®šä¹‰å¥åº·æ£€æŸ¥
@Component
public class DatabaseHealthIndicator implements HealthIndicator {
    
    @Autowired
    private DataSource dataSource;
    
    @Override
    public Health health() {
        try (Connection conn = dataSource.getConnection()) {
            if (conn.isValid(1)) {
                return Health.up().withDetail("database", "UP").build();
            }
        } catch (Exception e) {
            return Health.down(e).withDetail("database", "DOWN").build();
        }
        return Health.down().withDetail("database", "DOWN").build();
    }
}
```

#### PrometheusæŸ¥è¯¢ç¤ºä¾‹
```promql
# CPUä½¿ç”¨ç‡
100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle", job="bankshield-api"}[5m])) * 100)

# å†…å­˜ä½¿ç”¨ç‡
(node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100

# HTTPè¯·æ±‚é€Ÿç‡
sum(rate(http_requests_total{job="bankshield-api"}[5m])) by (uri)

# é”™è¯¯ç‡
sum(rate(http_requests_total{job="bankshield-api", status=~"5.."}[5m])) / 
sum(rate(http_requests_total{job="bankshield-api"}[5m])) * 100

# JVMå †å†…å­˜ä½¿ç”¨é‡
jvm_memory_used_bytes{area="heap", job="bankshield-api"}
```

### 5. å¤‡ä»½æ¢å¤

#### æ•°æ®åº“å¤‡ä»½
```bash
# MySQLå…¨é‡å¤‡ä»½
mysqldump -u root -p bankshield > bankshield_$(date +%Y%m%d_%H%M%S).sql

# MySQLå¢é‡å¤‡ä»½ï¼ˆåŸºäºbinlogï¼‰
mysqlbinlog --database=bankshield /var/log/mysql/mysql-bin.000001 > binlog_001.sql

# å‹ç¼©å¤‡ä»½
mysqldump -u root -p bankshield | gzip > bankshield_$(date +%Y%m%d).sql.gz

# è‡ªåŠ¨å¤‡ä»½è„šæœ¬
# scripts/backup-database.sh
#!/bin/bash
BACKUP_DIR="/backup/bankshield"
DATE=$(date +%Y%m%d_%H%M%S)
mysqldump -u root -p'password' bankshield > ${BACKUP_DIR}/bankshield_${DATE}.sql
gzip ${BACKUP_DIR}/bankshield_${DATE}.sql
find ${BACKUP_DIR} -name "bankshield_*.sql.gz" -mtime +7 -delete
```

#### å¯†é’¥å¤‡ä»½
```bash
# Vaultå¯†é’¥å¤‡ä»½
vault operator unseal
vault read -field=keys secret/bankshield/encryption-keys > keys-backup.json

# åŠ å¯†å¯†é’¥å¤‡ä»½
openssl enc -aes-256-cbc -salt -in keys-backup.json -out keys-backup.enc -k "BACKUP_PASSWORD"
```

## ç¯å¢ƒé…ç½®å¿«é€Ÿå‚è€ƒ

### å¼€å‘ç¯å¢ƒï¼ˆDevelopmentï¼‰
```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆæ¨èï¼‰
./scripts/start.sh --dev

# æˆ–è€…åˆ†æ­¥å¯åŠ¨ï¼š
mysql -u root -p dev_password < sql/init_database.sql
cd bankshield-api && mvn spring-boot:run
cd bankshield-ui && npm run dev

# è®¿é—®åœ°å€
å‰ç«¯: http://localhost:3000
åç«¯: http://localhost:8080/api
Druidç›‘æ§: http://localhost:8080/api/druid/login.htmlï¼ˆadmin/123456ï¼‰

# é»˜è®¤è´¦å·
admin/123456    # è¶…çº§ç®¡ç†å‘˜
security/123456 # å®‰å…¨ç®¡ç†å‘˜
audit/123456    # å®¡è®¡ç®¡ç†å‘˜
user/123456     # æ™®é€šç”¨æˆ·
```

### æµ‹è¯•ç¯å¢ƒï¼ˆTestingï¼‰
```bash
# éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
kubectl apply -f k8s/test/

# æˆ–ä½¿ç”¨Helm
helm install bankshield-test ./helm/bankshield \
  --namespace bankshield-test \
  --set api.image.tag=latest \
  --set ui.image.tag=latest

# è®¿é—®åœ°å€
https://test.bankshield.com

# è¿è¡Œæµ‹è¯•
mvn clean verify -Dspring.profiles.active=test
cd bankshield-ui && npm run test:e2e
```

### ç”Ÿäº§ç¯å¢ƒï¼ˆProductionï¼‰
```bash
# éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼ˆéœ€è¦å®¡æ‰¹ï¼‰
./scripts/deploy.sh prod v1.0.0

# è®¿é—®åœ°å€
https://bankshield.com

# ç›‘æ§å‘Šè­¦
Grafana: https://grafana.bankshield.com
Prometheus: https://prometheus.bankshield.com
Alertmanager: https://alertmanager.bankshield.com
Vault: https://vault.bankshield.com

# æ—¥å¿—æŸ¥çœ‹
kubectl logs -f deployment/bankshield-api -n bankshield-prod --tail=100
```

## æŠ€æœ¯æ”¯æŒ

### æ–‡æ¡£ç´¢å¼•
- [é¡¹ç›®æ¶æ„è®¾è®¡](docs/architecture.md)
- [APIæ–‡æ¡£](docs/api-spec.md)
- [æ•°æ®åº“è®¾è®¡](docs/fsd.md)
- [å®‰å…¨è§„èŒƒ](docs/security-hardening.md)
- [ç›‘æ§å‘Šè­¦é…ç½®](monitoring/README.md)
- [æ•°æ®è¡€ç¼˜](DATA_LINEAGE_MODULE_SUMMARY.md)
- [åˆè§„æŠ¥å‘Š](COMPLIANCE_REPORT_MODULE_SUMMARY.md)

### è”ç³»æ–¹å¼
- **æŠ€æœ¯æ”¯æŒ**: tech-support@bankshield.com
- **å®‰å…¨å›¢é˜Ÿ**: security@bankshield.com
- **è¿ç»´å›¢é˜Ÿ**: ops@bankshield.com
- **å€¼ç­ç”µè¯**: +86-400-123-4567

### é—®é¢˜åé¦ˆ
```bash
# GitHub Issues
git@github.com:bankshield/bankshield/issues

# Slack Channel
#bankshield-tech-support

# é’‰é’‰ç¾¤
BankShieldæŠ€æœ¯äº¤æµç¾¤ï¼ˆäºŒç»´ç è§README.mdï¼‰
```

## æ›´æ–°æ—¥å¿—

### 2024-01-24
- âœ… æ·»åŠ æ•°æ®è¡€ç¼˜æ¨¡å—å¼€å‘è§„èŒƒ
- âœ… å®Œå–„å›½å¯†ç®—æ³•ä½¿ç”¨æŒ‡å—
- âœ… è¡¥å……å¸¸è§é—®é¢˜è§£ç­”
- âœ… é›†æˆVaultå¯†é’¥ç®¡ç†
- âœ… æ·»åŠ æ€§èƒ½æµ‹è¯•k6è„šæœ¬ç¤ºä¾‹

### 2024-01-20
- âœ… åˆ›å»ºåˆå§‹å¼€å‘æŒ‡å—
- âœ… å®šä¹‰ä»£ç è§„èŒƒ
- âœ… è¯´æ˜æŠ€æœ¯æ ˆé€‰æ‹©
- âœ… æ·»åŠ CI/CDæµç¨‹
- âœ… é…ç½®å¤šç¯å¢ƒéƒ¨ç½²

---

**æ³¨æ„**: æœ¬æ–‡æ¡£ä¼šæ ¹æ®é¡¹ç›®å‘å±•æŒç»­æ›´æ–°ï¼Œè¯·å®šæœŸæŸ¥çœ‹æœ€æ–°ç‰ˆæœ¬ã€‚å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒé¡¹ç›®æ–‡æ¡£æˆ–è”ç³»æŠ€æœ¯æ”¯æŒã€‚
